<app-header-p></app-header-p>

<div class="max-w-4xl mx-auto p-6 bg-[#0A092B] text-white rounded-lg shadow-lg mt-8">
  <h2 class="text-4xl font-bold mb-8 text-center text-[#8002FF]">📘 Détail du cours</h2>

  <!-- Contenu du cours -->
  <section *ngIf="contenuHtml; else loading" [innerHTML]="contenuHtml" class="prose prose-invert max-w-none
                  [&_img]:mx-auto [&_img]:my-4 [&_img]:rounded-lg [&_img]:shadow-md
                  [&_p]:text-justify [&_h1]:text-2xl [&_h2]:text-xl [&_ul]:list-disc [&_ul]:pl-6"
    aria-label="Contenu du cours">
  </section>

  <ng-template #loading>
    <p class="text-center text-lg italic mt-8" role="status" aria-live="polite">Chargement du contenu...</p>
  </ng-template>

  <section *ngIf="(qcm?.length ?? 0) > 0" class="mt-12 p-6 bg-[#1C1B3A] rounded-lg shadow-xl border border-[#8002FF]"
    aria-label="Questionnaire à choix multiple">
    <h3 class="text-2xl font-semibold text-center mb-4 text-[#00FFC2]">📝 QCM associé</h3>

    <form (ngSubmit)="validerQCM()" #qcmForm="ngForm" novalidate>

      <fieldset *ngFor="let question of qcm; let i = index" [ngClass]="{
                  'bg-green-700 rounded p-4 mb-6': resultat !== null && questionEstJuste(i),
                  'bg-red-700 rounded p-4 mb-6': resultat !== null && !questionEstJuste(i)
                }" aria-live="polite">

        <legend class="font-medium mb-2 text-white cursor-default">
          🔹 Question {{ i + 1 }} : {{ question.intitule }}
        </legend>

        <ul class="list-disc list-inside space-y-2 ml-4">
          <li *ngFor="let reponse of question.reponses; let j = index">
            <label class="inline-flex items-center cursor-pointer select-none" [ngClass]="{
                     'text-[#00FFC2] font-semibold': questionEstJuste(i) && isBonneReponse(question, j),
                     'line-through text-red-400': resultat !== null && !questionEstJuste(i) && estCoche(i,j) && !isBonneReponse(question, j),
                     'text-white': !(questionEstJuste(i) && isBonneReponse(question, j)) && !(resultat !== null && !questionEstJuste(i) && estCoche(i,j) && !isBonneReponse(question, j))
                   }">
              <input type="checkbox" class="mr-2 rounded focus:ring-2 focus:ring-[#8002FF]"
                name="question-{{i}}-reponse-{{j}}" [(ngModel)]="reponsesChoisies[i][j]"
                [disabled]="resultat !== null" />

              <span>{{ reponse }}</span>
            </label>
          </li>
        </ul>

        <p *ngIf="resultat !== null && questionEstJuste(i)" class="text-[#00FFC2] font-semibold mt-2" role="alert">
          🎉 Bravo, bonne réponse !
        </p>
        <p *ngIf="resultat !== null && !questionEstJuste(i)" class="text-red-500 font-semibold mt-2" role="alert">
          ❌ Mauvaise réponse, réessayez !
        </p>
      </fieldset>

      <div class="flex justify-center gap-4 mt-6">
        <button type="submit"
          class="px-6 py-3 bg-[#8002FF] text-white rounded hover:bg-[#a136ff] transition-colors disabled:opacity-60 disabled:cursor-not-allowed"
          [disabled]="resultat !== null" [attr.aria-disabled]="resultat !== null">
          Valider
        </button>

        <button type="button" class="px-6 py-3 bg-gray-600 text-white rounded hover:bg-gray-700 transition-colors"
          (click)="reinitialiserQCM()" [disabled]="resultat === null" [attr.aria-disabled]="resultat === null">
          Réinitialiser
        </button>

      </div>

    </form>

    <div *ngIf="resultat !== null" class="mt-6 text-center text-xl font-semibold text-[#00FFC2]" aria-live="polite"
      role="status">
      Résultat : {{ resultat }} / {{ qcm.length }} bonne{{ resultat > 1 ? 's' : '' }} réponse{{ resultat > 1 ? 's' : ''
      }} !
    </div>
  </section>
</div>