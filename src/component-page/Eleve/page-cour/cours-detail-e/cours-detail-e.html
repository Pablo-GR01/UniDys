<app-header-e></app-header-e>

<!-- Wrapper principal -->
<div class="max-w-5xl mx-auto p-6 bg-[var(--Bleu)] text-[var(--Blanc)] 
            rounded-2xl shadow-2xl mt-8 border border-[var(--Violet)]">

  <h2 class="text-4xl font-extrabold mb-4 text-center text-[var(--Violet)] drop-shadow-lg">
    <i class="fa-solid fa-book-open"></i> Détail du cours
  </h2>

  <!-- ================= CONTROLES FIXES ================= -->
  <div class="flex flex-col md:flex-row justify-center items-center gap-6 mb-6 no-scale">
    
    <!-- Boutons taille -->
    <div class="flex items-center gap-4">
      <button (click)="diminuerTexte()"
              class="p-2 pl-3 pr-3 bg-[var(--Violet)] rounded-full text-[var(--Blanc)] hover:bg-[var(--Violet-Foncé)] transition">
        <i class="fas fa-minus"></i>
      </button>

      <span class="text-[var(--Blanc)] font-semibold">Taille : {{ texteTaille }}px</span>

      <button (click)="augmenterTexte()"
              class="p-2 pl-3 pr-3 bg-[var(--Violet)] rounded-full text-[var(--Blanc)] hover:bg-[var(--Violet-Foncé)] transition">
        <i class="fas fa-plus"></i>
      </button>
    </div>

    <!-- Menu déroulant police -->
    <div class="flex items-center gap-3">
      <label class="text-[var(--Blanc)] font-semibold">Police :</label>
      <select [(ngModel)]="policeTexte" (change)="changerPolice()"
              class="p-2 rounded-lg bg-[var(--Violet)] text-[var(--Blanc)] hover:bg-[var(--Violet-Foncé)] transition cursor-pointer">
        <option *ngFor="let font of policesDisponibles" [value]="font">{{ font }}</option>
      </select>
    </div>

  </div>
  <!-- =================================================== -->

  <!-- Zone qui suit taille et police -->
  <div [ngStyle]="{'font-size.px': texteTaille, 'font-family': policeTexte}">
    
    <!-- Contenu HTML du cours -->
    <section *ngIf="contenuHtml" [innerHTML]="contenuHtml"
             class="prose prose-invert max-w-none leading-relaxed
                    [&_img]:mx-auto [&_img]:my-4 [&_img]:rounded-xl [&_img]:shadow-md
                    [&_p]:text-justify [&_h1]:text-3xl [&_h2]:text-2xl [&_ul]:list-disc [&_ul]:pl-6"
             aria-label="Contenu du cours">
    </section>

    <div *ngIf="loading" class="flex justify-center items-center p-8">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[var(--Blanc)]"></div>
      <span class="ml-3 text-[var(--Blanc)]">Chargement du contenu...</span>
    </div>

    <div *ngIf="!loading && !contenuHtml" class="text-center p-8 text-gray-400">
      Aucun contenu disponible
    </div>

    <!-- Section QCM -->
    <section *ngIf="qcm.length > 0"
             class="mt-12 p-6 bg-gradient-to-b from-[var(--Bleu)] to-[var(--Violet)] rounded-xl shadow-xl border-4 border-[var(--Violet)] transition-all duration-300"
             aria-label="Questionnaire à choix multiple">

      <div class="flex justify-between items-center mb-4">
        <h3 class="text-2xl font-semibold text-[var(--Jaune)]"> 
          <i class="fa-solid fa-clipboard-list"></i> QCM associé
        </h3>
        <span class="text-[var(--Jaune)] font-semibold text-2xl">
          XP total : {{ xptotal }} XP
        </span>
      </div>

      <form (ngSubmit)="validerQCM()" #qcmForm="ngForm" novalidate class="space-y-6]">
        <fieldset *ngFor="let question of qcm; let questionIndex = index"
                  [ngClass]="{
                    'bg-green-900/20 border-l-4 border-[var(--Vert)] shadow-md': resultat !== null && questionEstJuste(questionIndex),
                    'bg-red-900/20 border-l-4 border-[var(--Rouge)] shadow-md': resultat !== null && !questionEstJuste(questionIndex),
                    'bg-[var(--Bleu)] border border-[var(--Violet)]/40': resultat === null
                  }" class="rounded-xl p-6 transition-all duration-300 hover:scale-[1.01] relative border-4 ">

          <legend class="text-lg font-bold text-[var(--Blanc)] mb-4 flex justify-between items-center ">
            <div class="flex items-center gap-2">
              <span class="px-3 py-1 bg-[var(--Violet)] rounded-full text-sm font-medium">
                {{ questionIndex + 1 }}/{{ qcm.length }}
              </span>
              <span class="text-[var(--Jaune)] text-2xl">{{ question.question || 'Question sans titre' }}</span>
            </div>
            <span class="absolute text-[var(--Jaune)] font-semibold text-2xl mt-4 whitespace-nowrap"
              style="right: 1rem; top: 0.5rem;">
              {{ question.xp || 0 }} XP
            </span>
          </legend>

          <ul class="space-y-3">
            <li *ngFor="let reponse of question.reponses; let reponseIndex = index">
              <label class="flex items-center gap-3 px-4 py-2 rounded-lg transition-all duration-200 cursor-pointer"
                     [ngClass]="{
                       'bg-[var(--Vert)] text-[var(--Blanc)] font-semibold': resultat !== null && isBonneReponse(question, reponseIndex),
                       'bg-[var(--Rouge)] text-[var(--Blanc)] line-through': resultat !== null && !questionEstJuste(questionIndex) && estCoche(questionIndex, reponseIndex) && !isBonneReponse(question, reponseIndex),
                       'bg-white/10 text-[var(--Blanc)] hover:bg-white/20': !(resultat !== null && isBonneReponse(question, reponseIndex)) && !(resultat !== null && !questionEstJuste(questionIndex) && estCoche(questionIndex, reponseIndex) && !isBonneReponse(question, reponseIndex))
                     }">
                <input type="radio" name="qcm_{{ questionIndex }}" [value]="reponseIndex"
                       [(ngModel)]="reponsesUtilisateur[questionIndex]" [disabled]="qcmDejaFait || resultat !== null" />
                <span>{{ reponse }}</span>
              </label>
            </li>
          </ul>

        </fieldset>

        <div class="flex justify-center mt-6">
          <button *ngIf="!qcmDejaFait" type="submit"
            class="px-8 py-3 bg-[var(--Violet)] text-[var(--Blanc)] font-semibold rounded-full shadow-lg hover:bg-[var(--Violet-Foncé)] active:scale-95 transition duration-200">
            Valider mes réponses
          </button>

          <button *ngIf="qcmDejaFait" type="button" (click)="showPopup = true"
            class="px-8 py-3 border-4 border-[var(--Jaune)] text-[var(--Blanc)] font-black rounded-full shadow-lg hover:bg-[var(--Violet-Foncé)] hover:text-[var(--Blanc)] active:scale-95 transition duration-200">
            Voir mes résultats
          </button>
        </div>
      </form>
    </section>

    <!-- Popup résultats -->
    <div *ngIf="showPopup && resultat !== null" class="fixed inset-0 bg-black/30 flex items-center justify-center z-50">
      <div class="bg-[var(--Bleu)] p-6 rounded-xl border border-[var(--Violet)] bg-gradient-to-t from-[var(--Bleu)] to-[var(--Violet)] max-w-md text-center text-[var(--Blanc)] shadow-lg">
        <p class="text-2xl font-bold mb-4" [ngClass]="{
             'text-[var(--Vert)]': resultat === (qcm?.length ?? 0),
             'text-[var(--Jaune)]': resultat > 0 && resultat < (qcm?.length ?? 0),
             'text-[var(--Rouge)]': resultat === 0
           }">
          {{ message }}
        </p>
        <p class="text-[var(--Vert)] text-lg">
          Résultat : <strong>{{ resultat }} / {{ qcm?.length }}</strong> bonne{{ resultat > 1 ? 's' : '' }} réponse{{ resultat > 1 ? 's' : '' }}.
        </p>
        <p class="text-[var(--Jaune)] text-lg mt-2 font-medium">
          Tu gagnes <strong>{{ xp }}</strong> XP !
        </p>
        <button class="mt-6 px-6 py-2 bg-[var(--Violet)] rounded-full font-semibold hover:bg-[var(--Violet-Foncé)]" (click)="fermerPopup()">
          Fermer
        </button>
      </div>
    </div>
  </div>
</div>