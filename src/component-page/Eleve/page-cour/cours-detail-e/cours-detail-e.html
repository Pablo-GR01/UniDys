<app-header-e></app-header-e>

<div class="min-h-screen w-full bg-[var(--Bleu-Foncé)] flex flex-col md:flex-row">
  <!-- ========= GAUCHE : barre outils + cours ========= -->
  <div class="flex-1 flex flex-col overflow-y-auto scrollbar-thin scrollbar-thumb-[var(--Violet)] scrollbar-track-[var(--Bleu)] p-4 md:p-0">

    <!-- BARRE OUTILS -->
    <section class="bg-[var(--Bleu)] text-[var(--Blanc)] border-b border-[var(--Violet)] p-6 shadow-xl rounded-b-2xl mb-4">
      <div class="flex items-center gap-4 mb-6">
        <div class="w-12 h-12 bg-gradient-to-br from-[var(--Violet)] to-[var(--Violet-Foncé)] rounded-xl flex items-center justify-center shadow-lg">
          <i class="fa-solid fa-universal-access text-white text-lg"></i>
        </div>
        <h2 class="text-2xl font-bold tracking-wide">Outils d’aide</h2>
      </div>

      <!-- CONTROLES -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5">
        <!-- TAILLE -->
        <div class="bg-[var(--Bleu-Foncé)] rounded-2xl p-4 border border-[var(--Violet)] shadow-md hover:shadow-xl transition-all duration-300">
          <label class="text-xs font-semibold mb-3 block text-gray-200">Taille du texte</label>
          <div class="flex items-center gap-3">
            <button (click)="diminuerTexte()" aria-label="Diminuer la taille du texte" 
                    class="w-10 h-10 bg-[var(--Violet)] hover:bg-[var(--Violet-Foncé)] text-white rounded-full flex items-center justify-center transition-transform duration-200 hover:scale-110 active:scale-95 shadow-md">
              <i class="fas fa-minus"></i>
            </button>
            <span class="font-bold text-sm min-w-[36px] text-center">{{ texteTaille }}px</span>
            <button (click)="augmenterTexte()" aria-label="Augmenter la taille du texte" 
                    class="w-10 h-10 bg-[var(--Violet)] hover:bg-[var(--Violet-Foncé)] text-white rounded-full flex items-center justify-center transition-transform duration-200 hover:scale-110 active:scale-95 shadow-md">
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>

        <!-- POLICE -->
        <div class="bg-[var(--Bleu-Foncé)] rounded-2xl p-4 border border-[var(--Violet)] shadow-md hover:shadow-xl transition-all duration-300">
          <label class="text-xs font-semibold mb-3 block text-gray-200">Police</label>
          <select [(ngModel)]="policeTexte" (change)="changerPolice()" 
                  class="w-full p-2 rounded-lg border border-[var(--Violet)] bg-[var(--Bleu)] text-white text-sm focus:outline-none focus:ring-2 focus:ring-[var(--Violet)] transition">
            <option *ngFor="let font of policesDisponibles" [value]="font">{{ font }}</option>
          </select>
        </div>

        <!-- MISE EN FORME -->
        <div class="bg-[var(--Bleu-Foncé)] rounded-2xl p-4 border border-[var(--Violet)] shadow-md hover:shadow-xl transition-all duration-300">
          <label class="text-xs font-semibold mb-3 block text-gray-200">Mise en forme</label>
          <div class="grid grid-cols-2 gap-3">
            <button (click)="toggleGras()" [class.ring-2]="grasActif" 
                    class="p-3 bg-[var(--Bleu)] hover:bg-[var(--Violet)] rounded-xl flex items-center justify-center transition transform hover:scale-110 focus:ring-2 focus:ring-[var(--Violet)]">
              <i class="fas fa-bold"></i>
            </button>
            <button (click)="toggleItalique()" [class.ring-2]="italiqueActif" 
                    class="p-3 bg-[var(--Bleu)] hover:bg-[var(--Violet)] rounded-xl flex items-center justify-center transition transform hover:scale-110 focus:ring-2 focus:ring-[var(--Violet)]">
              <i class="fas fa-italic"></i>
            </button>
            <button (click)="toggleSouligner()" [class.ring-2]="soulignerActif" 
                    class="p-3 bg-[var(--Bleu)] hover:bg-[var(--Violet)] rounded-xl flex items-center justify-center transition transform hover:scale-110 focus:ring-2 focus:ring-[var(--Violet)]">
              <i class="fas fa-underline"></i>
            </button>
            <button (click)="toggleBarrer()" [class.ring-2]="barrerActif" 
                    class="p-3 bg-[var(--Rouge)] hover:bg-red-600 rounded-xl flex items-center justify-center transition transform hover:scale-110 focus:ring-2 focus:ring-red-400">
              <i class="fas fa-strikethrough"></i>
            </button>
          </div>
        </div>

        <!-- SURLIGNEUR -->
        <div class="bg-[var(--Bleu-Foncé)] rounded-2xl p-4 border border-[var(--Violet)] shadow-md hover:shadow-xl transition-all duration-300">
          <label class="text-xs font-semibold mb-3 block text-gray-200">Surligneur</label>
          <div class="flex items-center gap-3">
            <i class="fas fa-highlighter text-[var(--Violet)] text-lg"></i>
            <select [(ngModel)]="couleurSurligneur" (change)="toggleSurligner()" 
                    class="flex-1 p-2 rounded-lg border border-[var(--Violet)] text-sm bg-[var(--Bleu)] text-white focus:outline-none focus:ring-2 focus:ring-[var(--Violet)] transition">
              <option *ngFor="let couleur of couleursSurligneur" [value]="couleur.code" 
                      [ngStyle]="{'background-color': couleur.code, 'color': getTextColor(couleur.code)}">
                &#9632; {{ couleur.nom }}
              </option>
            </select>
          </div>
        </div>
      </div>
    </section>

    <!-- COURS -->
    <section class="flex-1 bg-[var(--Bleu)] text-[var(--Blanc)] p-6 rounded-2xl shadow-lg">
      <div class="flex items-center gap-4 mb-6">
        <div class="w-12 h-12 bg-gradient-to-br from-[var(--Violet)] to-[var(--Violet-Foncé)] rounded-xl flex items-center justify-center shadow-lg">
          <i class="fa-solid fa-book-open text-white text-lg"></i>
        </div>
        <h2 class="text-2xl font-bold tracking-wide">Cours</h2>
      </div>
      <div class="text-[var(--Blanc)] leading-relaxed text-justify whitespace-pre-line space-y-5 user-highlight"
           [ngStyle]="{'font-size.px': texteTaille, 'font-family': policeTexte}">
        <ng-container *ngIf="contenuHtml; else noContent">
          <div [innerHTML]="contenuHtml"></div>
        </ng-container>
        <ng-template #noContent>
          <div class="text-center p-6 opacity-80 italic">Aucun contenu disponible.</div>
        </ng-template>
      </div>
    </section>
  </div>

  <!-- ========= DROITE : QCM ========= -->
  <aside class="w-full md:w-[360px] bg-[var(--Bleu)] text-[var(--Blanc)] border-l border-[var(--Violet)] p-6 overflow-y-auto scrollbar-thin scrollbar-thumb-[var(--Violet)] scrollbar-track-[var(--Bleu)]">
    <div class="flex items-center gap-4 mb-6">
      <div class="w-12 h-12 bg-gradient-to-br from-[var(--Violet)] to-[var(--Violet-Foncé)] rounded-xl flex items-center justify-center shadow-lg">
        <i class="fa-solid fa-clipboard-list text-white text-lg"></i>
      </div>
      <h2 class="text-2xl font-bold tracking-wide">Questions</h2>
    </div>

    <div class="bg-[var(--Bleu-Foncé)] rounded-2xl p-5 border border-[var(--Violet)] shadow-xl">
      <div class="flex justify-between items-center mb-5">
        <span class="text-sm font-semibold">XP total : <span class="text-[var(--Violet)] font-bold">{{ xptotal }} XP</span></span>
        <span class="bg-[var(--Violet)] px-3 py-1 rounded-full text-xs font-semibold">{{ qcm.length }} questions</span>
      </div>

      <form (ngSubmit)="validerQCM()" #qcmForm="ngForm" class="space-y-5 text-sm">
        <div *ngFor="let question of qcm; let i = index"
             [ngClass]="{
               'border-l-4 border-green-500 bg-green-900/25': resultat !== null && questionEstJuste(i),
               'border-l-4 border-red-500 bg-red-900/25': resultat !== null && !questionEstJuste(i),
               'border border-[var(--Violet)]': resultat === null
             }"
             class="rounded-2xl p-4 bg-[var(--Bleu-Foncé)] flex flex-col gap-3 transition-shadow hover:shadow-lg">

          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
            <span class="font-semibold">{{ i + 1 }}. {{ question.question }}</span>
            <span class="text-xs bg-[var(--Violet)] px-2 py-1 rounded-full">{{ question.xp || 0 }} XP</span>
          </div>

          <div class="flex flex-wrap gap-2">
            <ng-container *ngFor="let r of question.reponses; let j = index">
              <label [ngClass]="{
                    'bg-green-500 text-white': resultat !== null && isBonneReponse(question, j),
                    'bg-red-500 line-through text-white': resultat !== null && estCoche(i, j) && !isBonneReponse(question, j),
                    'bg-[var(--Bleu)] hover:bg-[var(--Violet)]': resultat === null
                  }" class="flex items-center gap-2 px-4 py-2 rounded-xl cursor-pointer transition transform hover:scale-105">
                <input type="radio" [name]="'qcm_' + i" [value]="j" [(ngModel)]="reponsesUtilisateur[i]"
                  [disabled]="qcmDejaFait || resultat !== null" class="w-4 h-4 accent-[var(--Violet)]" />
                <span class="text-sm">{{ r }}</span>
              </label>
            </ng-container>
          </div>
        </div>

        <div class="flex justify-center pt-5">
          <button *ngIf="!qcmDejaFait" type="submit" 
                  class="px-6 py-3 bg-[var(--Violet)] hover:bg-[var(--Violet-Foncé)] rounded-2xl font-semibold transition transform hover:scale-105 shadow-lg">
            Valider
          </button>
          <button *ngIf="qcmDejaFait" type="button" (click)="showPopup = true" 
                  class="px-6 py-3 bg-yellow-500 hover:bg-yellow-600 rounded-2xl font-semibold transition transform hover:scale-105 shadow-lg">
            Voir les résultats
          </button>
        </div>
      </form>
    </div>
  </aside>
</div>
