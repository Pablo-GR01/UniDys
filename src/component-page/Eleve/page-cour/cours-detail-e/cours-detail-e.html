<app-header-e></app-header-e>

<div class="max-w-5xl mx-auto p-6 bg-[var(--Bleu)] text-[var(--Blanc)] rounded-2xl shadow-2xl mt-8 border border-[var(--Violet)]">
  <h2 class="text-4xl font-extrabold mb-8 text-center text-[var(--Violet)] drop-shadow-lg">
    üìö D√©tail du cours
  </h2>

  <!-- Contenu HTML du cours -->
  <section *ngIf="contenuHtml" [innerHTML]="contenuHtml" class="prose prose-invert max-w-none leading-relaxed
                  [&_img]:mx-auto [&_img]:my-4 [&_img]:rounded-xl [&_img]:shadow-md
                  [&_p]:text-justify [&_h1]:text-3xl [&_h2]:text-2xl [&_ul]:list-disc [&_ul]:pl-6"
    aria-label="Contenu du cours">
  </section>

  <div *ngIf="loading" class="flex justify-center items-center p-8">
    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[var(--Blanc)]"></div>
    <span class="ml-3 text-[var(--Blanc)]">Chargement du contenu...</span>
  </div>

  <div *ngIf="!loading && !contenuHtml" class="text-center p-8 text-gray-400">
    Aucun contenu disponible
  </div>

  <!-- Section QCM -->
  <section *ngIf="qcm.length > 0"
    class="mt-12 p-6 bg-[var(--Bleu-Fonc√©)] rounded-xl shadow-xl border border-[var(--Violet)] transition-all duration-300"
    aria-label="Questionnaire √† choix multiple">

    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-semibold text-[#FFD700]">üìù QCM associ√©</h3>
      <span class="text-[#FFD700] font-semibold text-lg">
        XP total : {{ xptotal }} XP
      </span>
    </div>

    <form (ngSubmit)="validerQCM()" #qcmForm="ngForm" novalidate class="space-y-6">

      <fieldset *ngFor="let question of qcm; let questionIndex = index" [ngClass]="{
                  'bg-green-900/20 border-l-4 border-green-500 shadow-md': resultat !== null && questionEstJuste(questionIndex),
                  'bg-red-900/20 border-l-4 border-red-500 shadow-md': resultat !== null && !questionEstJuste(questionIndex),
                  'bg-[var(--Bleu)] border border-[var(--Violet)]/40': resultat === null
                }" class="rounded-xl p-6 transition-all duration-300 hover:scale-[1.01] relative">

        <legend class="text-lg font-bold text-[var(--Blanc)] mb-4 flex justify-between items-center">
          <div class="flex items-center gap-2">
            <span class="px-3 py-1 bg-[var(--Violet)] rounded-full text-sm font-medium">
              {{ questionIndex + 1 }}/{{ qcm.length }}
            </span>
            <span class="text-[#00FFC2]">{{ question.question || 'Question sans titre' }}</span>
          </div>
          <span class="absolute text-[#FFD410] font-semibold text-2xl whitespace-nowrap"
            style="right: 1rem; top: 0.5rem;">
            {{ question.xp || 0 }} XP
          </span>
        </legend>

        <ul class="space-y-3">
          <li *ngFor="let reponse of question.reponses; let reponseIndex = index">
            <label class="flex items-center gap-3 px-4 py-2 rounded-lg transition-all duration-200 cursor-pointer"
              [ngClass]="{
                     'bg-green-400/80 text-green-900 font-semibold': resultat !== null && isBonneReponse(question, reponseIndex),
                     'bg-red-400/80 text-red-900 line-through': resultat !== null && !questionEstJuste(questionIndex) && estCoche(questionIndex, reponseIndex) && !isBonneReponse(question, reponseIndex),
                     'bg-white/10 text-[var(--Blanc)] hover:bg-white/20': !(resultat !== null && isBonneReponse(question, reponseIndex)) && !(resultat !== null && !questionEstJuste(questionIndex) && estCoche(questionIndex, reponseIndex) && !isBonneReponse(question, reponseIndex))
                   }">
              <input type="radio" name="qcm_{{ questionIndex }}" [value]="reponseIndex"
                [(ngModel)]="reponsesUtilisateur[questionIndex]" [disabled]="qcmDejaFait || resultat !== null" />

              <span>{{ reponse }}</span>
            </label>
          </li>
        </ul>

      </fieldset>

      <div class="flex justify-center mt-6">
        <button *ngIf="!qcmDejaFait" type="submit"
          class="px-8 py-3 bg-[var(--Violet)] text-[var(--Blanc)] font-semibold rounded-full shadow-lg hover:bg-[var(--Violet-Fonc√©)] active:scale-95 transition duration-200">
          Valider mes r√©ponses
        </button>

        <button *ngIf="qcmDejaFait" type="button" (click)="showPopup = true"
          class="px-8 py-3 bg-[#FFD700] text-[var(--Bleu)] font-semibold rounded-full shadow-lg hover:bg-[#FFC400] active:scale-95 transition duration-200">
          Voir mes r√©sultats
        </button>
      </div>

    </form>
  </section>

  <!-- Popup r√©sultats -->
  <div *ngIf="showPopup && resultat !== null" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50">
    <div class="bg-[var(--Bleu)] p-6 rounded-xl border border-[var(--Violet)] max-w-md text-center text-[var(--Blanc)] shadow-lg">
      <p class="text-2xl font-bold mb-4" [ngClass]="{
           'text-green-400': resultat === (qcm?.length ?? 0),
           'text-yellow-400': resultat > 0 && resultat < (qcm?.length ?? 0),
           'text-red-400': resultat === 0
         }">
        {{ message }}
      </p>
      <p class="text-[#00FFC2] text-lg">
        R√©sultat : <strong>{{ resultat }} / {{ qcm?.length }}</strong> bonne{{ resultat > 1 ? 's' : '' }} r√©ponse{{
        resultat > 1 ? 's' : '' }}.
      </p>
      <p class="text-[#FFD700] text-lg mt-2 font-medium">
        Tu gagnes <strong>{{ xp }}</strong> XP !
      </p>
      <button class="mt-6 px-6 py-2 bg-[var(--Violet)] rounded-full font-semibold hover:bg-[var(--Violet-Fonc√©)]" (click)="fermerPopup()">
        Fermer
      </button>
    </div>
  </div>
</div>
